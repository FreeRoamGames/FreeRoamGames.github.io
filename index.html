<!DOCTYPE html>
<html lang="en-us">
<head>
    <title>DIEID</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        #main-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 400px;
            padding: 20px;
        }
        #message-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .message {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        .message.sent {
            background-color: #d1e7dd;
            text-align: right;
        }
        .message.received {
            background-color: #f8d7da;
            text-align: left;
        }
        textarea {
            width: calc(100% - 22px);
            height: 50px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: none;
            margin-bottom: 10px;
        }
        button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background-color: #007bff;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #aaa;
        }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="message-container"></div>
        <textarea id="txData" placeholder="Type a message..."></textarea>
        <button onclick="onSend();">Send</button>
    </div>

    <script type="text/javascript" src="js/data.js"></script>
    <script type="text/javascript">
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        window.OfflineAudioContext = window.OfflineAudioContext || window.webkitOfflineAudioContext;

        var context = null;
        var recorder = null;
        var ggwave = null;
        var parameters = null;
        var instance = null;

        ggwave_factory().then(function(obj) {
            ggwave = obj;
            init();
            startCapturing();
        });

        var txData = document.getElementById("txData");
        var messageContainer = document.getElementById("message-container");

        function convertTypedArray(src, type) {
            var buffer = new ArrayBuffer(src.byteLength);
            var baseView = new src.constructor(buffer).set(src);
            return new type(buffer);
        }

        function init() {
            if (!context) {
                context = new AudioContext({sampleRate: 48000});
                parameters = ggwave.getDefaultParameters();
                parameters.sampleRateInp = context.sampleRate;
                parameters.sampleRateOut = context.sampleRate;
                instance = ggwave.init(parameters);
            }
        }

        function onSend() {
            var message = txData.value.trim();
            if (message === "") return;
            addMessage(message, "sent");

            var waveform = ggwave.encode(instance, message, ggwave.ProtocolId.GGWAVE_PROTOCOL_AUDIBLE_FAST, 10);
            var buf = convertTypedArray(waveform, Float32Array);
            var buffer = context.createBuffer(1, buf.length, context.sampleRate);
            buffer.getChannelData(0).set(buf);
            var source = context.createBufferSource();
            source.buffer = buffer;
            source.connect(context.destination);
            source.start(0);

            txData.value = "";
        }

        function addMessage(message, type) {
            var messageElement = document.createElement("div");
            messageElement.classList.add("message", type);
            messageElement.textContent = message;
            messageContainer.appendChild(messageElement);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function startCapturing() {
            let constraints = {
                audio: {
                    echoCancellation: false,
                    autoGainControl: false,
                    noiseSuppression: false
                }
            };

            navigator.mediaDevices.getUserMedia(constraints).then(function (e) {
                var mediaStream = context.createMediaStreamSource(e);
                var bufferSize = 1024;

                if (context.createScriptProcessor) {
                    recorder = context.createScriptProcessor(bufferSize, 1, 1);
                } else {
                    recorder = context.createJavaScriptNode(bufferSize, 1, 1);
                }

                recorder.onaudioprocess = function (e) {
                    var source = e.inputBuffer;
                    var res = ggwave.decode(instance, convertTypedArray(new Float32Array(source.getChannelData(0)), Int8Array));

                    if (res && res.length > 0) {
                        res = new TextDecoder("utf-8").decode(res);
                        addMessage(res, "received");
                    }
                };

                mediaStream.connect(recorder);
                recorder.connect(context.destination);
            }).catch(function (e) {
                console.error(e);
            });
        }
    </script>
</body>
</html>
