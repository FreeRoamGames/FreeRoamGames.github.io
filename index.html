<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VR Hände mit Greifbewegung</title>
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@6.1.1/dist/aframe-extras.loaders.min.js"></script>
  <script src="https://cdn.pubnub.com/pubnub-4.28.5.min.js"></script>
</head>
<body>
  <a-scene renderer="antialias: true" background="color: #333">
    <!-- Skybox -->
    <a-sky src="skybox.png"></a-sky>

    <!-- Licht -->
    <a-light type="ambient" intensity="0.5"></a-light>
    <a-light type="directional" intensity="1" position="1 3 2"></a-light>

    <!-- Linke Hand -->
    <a-entity id="left-hand" 
              tracked-controls="hand: left; model: false"
              obj-model="obj: url(left.obj)"
              material="color: #bf9d7d"
              scale="0.5 0.5 0.5"
              rotation="90 0 90"
              position="0 0 0"
              class="hand"
              oculus-touch-controls="hand: left; model: false">
    </a-entity>

    <!-- Rechte Hand -->
    <a-entity id="right-hand" 
              tracked-controls="hand: right; model: false"
              obj-model="obj: url(right.obj)"
              material="color: #bf9d7d"
              scale="0.5 0.5 0.5"
              rotation="90 0 90"
              position="0 0 0"
              class="hand"
              oculus-touch-controls="hand: right; model: false">
    </a-entity>

    <!-- Kopf (Headset) mit head.obj, gleiche Farbe wie die Hände -->
    <a-entity id="head"
              obj-model="obj: url(head.obj)"
              material="color: #bf9d7d"
              scale="1.5 1.5 1.5"
              position="0 1.6 0"  <!-- Position auf Höhe des Kopfes -->
              rotation="0 0 0">
    </a-entity>

    <!-- Kamera -->
    <a-entity id="camera" camera position="0 1.6 0"></a-entity>
  </a-scene>

  <script>
    // PubNub-Konfiguration
    const playerId = 'player_' + Math.floor(Math.random() * 1000000);  // Zufällige ID für den Spieler
    const pubnub = new PubNub({
      publishKey: 'demo',  // Ersetze mit deinem Publish Key
      subscribeKey: 'demo',  // Ersetze mit deinem Subscribe Key
    });

    // Der Channel, den du verwendest
    const channel = 'puravida';

    // Senden der Positions- und Rotationsdaten der Hände und des Kopfes
    function sendPlayerData() {
      const leftHand = document.querySelector('#left-hand');
      const rightHand = document.querySelector('#right-hand');
      const head = document.querySelector('#head');
      const camera = document.querySelector('#camera');

      // Holen der Position und Rotation
      const leftHandPos = leftHand.getAttribute('position');
      const rightHandPos = rightHand.getAttribute('position');
      const headPos = head.getAttribute('position');
      const cameraPos = camera.getAttribute('position');
      
      const leftHandRot = leftHand.getAttribute('rotation');
      const rightHandRot = rightHand.getAttribute('rotation');
      const headRot = head.getAttribute('rotation');

      const playerData = {
        playerId: playerId,
        leftHand: { position: leftHandPos, rotation: leftHandRot },
        rightHand: { position: rightHandPos, rotation: rightHandRot },
        head: { position: headPos, rotation: headRot },
        camera: cameraPos
      };

      // Senden der Daten an PubNub
      pubnub.publish({
        channel: channel,
        message: playerData
      });
    }

    // Empfangen von anderen Spieler-Daten und Rendern
    pubnub.addListener({
      message: function(event) {
        const data = event.message;
        
        // Wenn es eine andere ID ist, erstelle das Spieler-Modell
        if (data.playerId !== playerId) {
          let otherPlayer = document.querySelector(`#player-${data.playerId}`);
          if (!otherPlayer) {
            otherPlayer = document.createElement('a-entity');
            otherPlayer.setAttribute('id', `player-${data.playerId}`);
            otherPlayer.setAttribute('obj-model', 'obj: url(left.obj)');
            otherPlayer.setAttribute('material', 'color: #bf9d7d');
            otherPlayer.setAttribute('scale', '0.5 0.5 0.5');
            document.querySelector('a-scene').appendChild(otherPlayer);
          }

          // Setze die Position und Rotation des anderen Spielers
          otherPlayer.setAttribute('position', data.leftHand.position);  // Beispiel für die linke Hand, anpassen je nach Bedarf
          otherPlayer.setAttribute('rotation', data.leftHand.rotation);  // Beispiel für die linke Hand, anpassen je nach Bedarf
        }
      }
    });

    pubnub.subscribe({
      channels: [channel]
    });

    // Synchronisiere den Kopf mit der Kamera
    function syncHeadWithCamera() {
      const head = document.querySelector('#head');
      const camera = document.querySelector('#camera');
      const cameraPos = camera.getAttribute('position');
      const cameraRot = camera.getAttribute('rotation');
      
      head.setAttribute('position', cameraPos);  // Kopf folgt der Kameraposition
      head.setAttribute('rotation', cameraRot);  // Kopf folgt der Kamerarotation
    }

    // Sende die Daten in regelmäßigen Abständen
    setInterval(sendPlayerData, 1000);  // Sende alle 1 Sekunde

    // Synchronisiere Kopf und Kamera
    setInterval(syncHeadWithCamera, 100);  // Synchronisiere alle 100ms (häufiger, damit der Kopf korrekt bewegt wird)

  </script>
</body>
</html>
